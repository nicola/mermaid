<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Mermaid Quick Test Page</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
  <style>
      div.mermaid {
        /* font-family: 'trebuchet ms', verdana, arial; */
        font-family: 'Courier New', Courier, monospace !important;
      }
  </style>
</head>
<body>
  <div class="mermaid">
    sequenceDiagram
        StorageMarket >>> StorageClient
        StorageMarket >>> StorageMarketActor
        StorageMarket >>> StorageProvider

        Blockchain >>> PaymentChannelActor
        Blockchain >>> StoragePowerConsensus
        Blockchain >>> StoragePowerActor


        StorageMining >>> StorageMinerActor
        StorageMining >>> SectorIndexing
        StorageMining >>> StorageProving

        participant FilProofs

        Note over StorageClient,StorageProvider: MarketsGroup
        Note over StorageClient,StorageProvider: StorageMarketSubsystem
        Note over Blockchain,StoragePowerActor: BlockchainGroup
        Note over StorageMining,StorageProving: MiningGroup


        opt RegisterStorageMiner
            StorageMining->>StorageMining: CreateMiner(WorkerPubKey)
            StorageMining->StoragePowerActor: RegisterMiner(OwnerAddr, WorkerPubKey)
            StoragePowerActor->StorageMining: StorageMinerActor
        end

        opt StorageDealMake
            Note left of StorageClient: Piece, PieceCID
            StorageClient->>StorageProvider: DealProposal
            StorageProvider->>StorageClient: DealResponse,DealAccepted,Deal
            Note left of StorageClient: Piece, PieceCID, Deal
            Note right of StorageProvider: Piece, PieceCID, Deal
            StorageClient->>StorageProvider: StorageDealQuery
            StorageProvider->>StorageClient: DealResponse,DealAccepted,Deal
        end

        opt AddingDealToSector
            StorageProvider->>StorageMining: MadeDeal(Deal,PieceRef)
            StorageMining->>+SectorIndexing: AddToSector(Deal, PieceRef)
            SectorIndexing-->>SectorIndexing: SectorID ← PackDealIntoSector(Deal)
            SectorIndexing-->>SectorIndexing: PIP ← PackSector(SectorID)
            SectorIndexing->>-StorageMining: SectorID
            StorageMining->>StorageProvider: DealInSector(Deal,PieceRef,PIP,SectorID)
        end

        opt ClientQuery
            StorageClient->>StorageProvider: StorageDealQuery
            StorageProvider->>StorageClient: DealResponse,DealAccepted,Deal,PIP
        end

        opt SealingSector
            StorageMining->>+StorageProving: SealSector(SectorID, ReplicaCfg)
            StorageProving-->>StorageProving: SealOutputs ← Seal(SectorID, ReplicaCfg)
            StorageProving->>-StorageMining: (SectorID,SealOutputs)
            opt CommitSector
                StorageMining-->>StorageMinerActor: CommitSector(SectorID, OnChainSectorInfo)
                StorageMinerActor-->>+FilProofs: VerifySeal(SectorID, OnChainSectorInfo)
                FilProofs-->>-StorageMinerActor: {1,0} ← VerifySeal
                alt 1 - success
                    StorageMinerActor-->>StorageMinerActor: ...Update State...
                    StorageMinerActor-->>StoragePowerActor: UpdatePower(MinerAddr)
                    StorageMinerActor-->>StorageMinerActor: 1 ← CommitSector(.)
                else 0 - failure
                    StorageMinerActor-->>StorageMinerActor: 0 ← CommitSector(.)
                end
            end
        end

        opt ClientQuery
            StorageClient->>StorageProvider: StorageDealQuery
            StorageProvider->>StorageClient: DealResponse,DealAccepted,Deal,PIP,SealedSectorCID
        end

        loop StorageDealCollect
            Note Right of StorageProvider: Deal
            alt Via Client
                StorageProvider ->> StorageClient: ReconcileRequest(Deal, [Voucher])
                opt If Client Does Not Have PIP
                    StorageClient -->> StorageProvider: StorageDealQuery(Deal)
                    StorageProvider -->> StorageClient: PieceID, SectorID, PIP
                end
                StorageClient -->> Blockchain: VerifySectorExists(SectorID)
                StorageClient --> StorageClient: VerifyPIP(SectorID, PIP)
                StorageClient -->> StorageClient: ReconcileResponse ← SignVouchers([Voucher])
                StorageClient ->> StorageProvider: ReconcileResponse
                StorageProvider ->> PaymentChannelActor: RedeemVoucher(ReconcileResponse.Voucher)

            else Via Blockchain

                StorageProvider ->> StorageMarketActor: RedeemVoucher(Voucher, PIP)
            end
        end
  </div>

  <hr/>

  <script src="./mermaid.js"></script>
  <script>
    mermaid.initialize({
      theme: 'forest',
      // themeCSS: '.node rect { fill: red; }',
      logLevel: 3,
      flowchart: { curve: 'basis' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 },
      // sequenceDiagram: { actorMargin: 300 } // deprecated
    });
  </script>
  <script>
    function ganttTestClick(a, b, c){
      console.log("a:", a)
      console.log("b:", b)
      console.log("c:", c)
    }
    function testClick(nodeId) {
      console.log("clicked", nodeId)
      var originalBgColor = document.querySelector('body').style.backgroundColor
      document.querySelector('body').style.backgroundColor = 'yellow'
      setTimeout(function() {
        document.querySelector('body').style.backgroundColor = originalBgColor
      }, 100)
    }
  </script>
</body>
</html>
